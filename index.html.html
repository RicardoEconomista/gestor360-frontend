// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GESTOR FINANCEIRO 360Â° - BACKEND COMPLETO E CORRIGIDO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INSTRUÃ‡Ã•ES:
// 1. GitHub: https://github.com/RicardoEconomista/gestor360-backend
// 2. Clica em: servidor.js
// 3. Clica no lÃ¡pis (Edit)
// 4. CTRL+A (seleciona tudo)
// 5. DELETE (apaga tudo)
// 6. COPIA TODO ESTE ARQUIVO
// 7. COLA no GitHub
// 8. Commit: "fix: servidor completo corrigido com CORS e health"
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const express = require('express');
const { createClient } = require('@supabase/supabase-js');
const jwt = require('jsonwebtoken');
const bcrypt = require('bcryptjs');
const cors = require('cors');

const app = express();
const PORT = process.env.PORT || 3000;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURAÃ‡ÃƒO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const supabaseUrl = process.env.SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_KEY;
const supabase = createClient(supabaseUrl, supabaseKey);

const JWT_SECRET = process.env.JWT_SECRET || 'seu_secret_aqui_mude_em_producao';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MIDDLEWARE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// CORS - CORRIGIDO!
app.use(cors({
    origin: [
        'https://gestor360-frontend.vercel.app',
        'http://localhost:5500',
        'http://127.0.0.1:5500',
        'https://gestor360-frontend-git-main-ricardo16.vercel.app',
        'https://gestor360-frontend-jt2p4alno-ricardo16.vercel.app'
    ],
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization']
}));

app.use(express.json());

// Middleware de verificaÃ§Ã£o de token
function verificarToken(req, res, next) {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1];
    
    if (!token) {
        console.log('âŒ Token nÃ£o fornecido');
        return res.status(401).json({ error: 'Token nÃ£o fornecido' });
    }
    
    jwt.verify(token, JWT_SECRET, (err, decoded) => {
        if (err) {
            console.log('âŒ Token invÃ¡lido:', err.message);
            return res.status(403).json({ error: 'Token invÃ¡lido' });
        }
        req.userId = decoded.userId;
        next();
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROTAS DE AUTENTICAÃ‡ÃƒO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Registro de usuÃ¡rio
app.post('/auth/register', async (req, res) => {
    console.log('ğŸ“¥ POST /auth/register');
    
    try {
        const { email, senha, nome } = req.body;
        
        if (!email || !senha) {
            return res.status(400).json({ error: 'Email e senha sÃ£o obrigatÃ³rios' });
        }
        
        // Criar usuÃ¡rio no Supabase Auth
        const { data: authData, error: authError } = await supabase.auth.signUp({
            email,
            password: senha
        });
        
        if (authError) {
            console.error('Erro ao criar usuÃ¡rio:', authError);
            throw authError;
        }
        
        console.log('âœ… UsuÃ¡rio criado:', authData.user.id);
        
        res.status(201).json({ 
            message: 'UsuÃ¡rio criado com sucesso',
            user: { 
                id: authData.user.id, 
                email: authData.user.email 
            }
        });
        
    } catch (error) {
        console.error('âŒ Erro no registro:', error);
        res.status(500).json({ 
            error: 'Erro ao criar usuÃ¡rio',
            details: error.message 
        });
    }
});

// Login de usuÃ¡rio
app.post('/auth/login', async (req, res) => {
    console.log('ğŸ“¥ POST /auth/login');
    
    try {
        const { email, senha } = req.body;
        
        if (!email || !senha) {
            return res.status(400).json({ error: 'Email e senha sÃ£o obrigatÃ³rios' });
        }
        
        // Autenticar com Supabase
        const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password: senha
        });
        
        if (error) {
            console.error('Erro no login:', error);
            throw error;
        }
        
        // Gerar JWT token
        const token = jwt.sign(
            { 
                userId: data.user.id, 
                email: data.user.email 
            },
            JWT_SECRET,
            { expiresIn: '7d' }
        );
        
        console.log('âœ… Login bem-sucedido:', data.user.id);
        
        res.json({ 
            token,
            user: {
                id: data.user.id,
                email: data.user.email
            }
        });
        
    } catch (error) {
        console.error('âŒ Erro no login:', error);
        res.status(401).json({ 
            error: 'Email ou senha incorretos',
            details: error.message 
        });
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROTAS DE EMPRESAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Criar empresa
app.post('/empresas', verificarToken, async (req, res) => {
    console.log('ğŸ“¥ POST /empresas');
    console.log('Body recebido:', JSON.stringify(req.body, null, 2));
    console.log('User ID:', req.userId);
    
    try {
        const { 
            nome_empresa, 
            setor, 
            porte, 
            faturamento_anual,
            dados_completos
        } = req.body;
        
        // ValidaÃ§Ãµes
        if (!nome_empresa) {
            console.error('âŒ nome_empresa faltando');
            return res.status(400).json({ error: 'Nome da empresa Ã© obrigatÃ³rio' });
        }
        
        if (!setor) {
            console.error('âŒ setor faltando');
            return res.status(400).json({ error: 'Setor Ã© obrigatÃ³rio' });
        }
        
        if (!porte) {
            console.error('âŒ porte faltando');
            return res.status(400).json({ error: 'Porte Ã© obrigatÃ³rio' });
        }
        
        console.log('âœ… ValidaÃ§Ãµes OK');
        console.log('Inserindo no Supabase...');
        
        // Inserir empresa
        const { data, error } = await supabase
            .from('empresas')
            .insert([{
                nome_empresa,
                setor,
                porte,
                faturamento_anual: faturamento_anual || 0,
                dados_completos: dados_completos || {},
                user_id: req.userId,
                owner_id: req.userId
            }])
            .select()
            .single();
        
        if (error) {
            console.error('âŒ Erro do Supabase:', error);
            throw error;
        }
        
        console.log('âœ… Empresa criada com sucesso:', data.id);
        
        res.status(201).json({ empresa: data });
        
    } catch (error) {
        console.error('âŒ Erro ao criar empresa:', error);
        res.status(500).json({ 
            error: 'Erro ao criar empresa',
            details: error.message,
            hint: error.hint || null
        });
    }
});

// Listar empresas
app.get('/empresas', verificarToken, async (req, res) => {
    console.log('ğŸ“¥ GET /empresas');
    console.log('User ID:', req.userId);
    
    try {
        const { data, error } = await supabase
            .from('empresas')
            .select('*')
            .or(`user_id.eq.${req.userId},owner_id.eq.${req.userId}`)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        console.log(`âœ… ${data.length} empresas encontradas`);
        
        res.json({ empresas: data });
        
    } catch (error) {
        console.error('âŒ Erro ao listar empresas:', error);
        res.status(500).json({ 
            error: 'Erro ao listar empresas',
            details: error.message 
        });
    }
});

// Buscar empresa por ID
app.get('/empresas/:id', verificarToken, async (req, res) => {
    console.log('ğŸ“¥ GET /empresas/:id');
    
    try {
        const { id } = req.params;
        
        const { data, error } = await supabase
            .from('empresas')
            .select('*')
            .eq('id', id)
            .single();
        
        if (error) throw error;
        
        // Verificar se usuÃ¡rio tem acesso
        if (data.user_id !== req.userId && data.owner_id !== req.userId) {
            return res.status(403).json({ error: 'Sem permissÃ£o para acessar esta empresa' });
        }
        
        console.log('âœ… Empresa encontrada:', id);
        
        res.json({ empresa: data });
        
    } catch (error) {
        console.error('âŒ Erro ao buscar empresa:', error);
        res.status(500).json({ 
            error: 'Erro ao buscar empresa',
            details: error.message 
        });
    }
});

// Atualizar empresa
app.put('/empresas/:id', verificarToken, async (req, res) => {
    console.log('ğŸ“¥ PUT /empresas/:id');
    
    try {
        const { id } = req.params;
        const updates = req.body;
        
        // Verificar permissÃ£o
        const { data: empresa } = await supabase
            .from('empresas')
            .select('user_id, owner_id')
            .eq('id', id)
            .single();
        
        if (!empresa || (empresa.user_id !== req.userId && empresa.owner_id !== req.userId)) {
            return res.status(403).json({ error: 'Sem permissÃ£o' });
        }
        
        // Atualizar
        const { data, error } = await supabase
            .from('empresas')
            .update(updates)
            .eq('id', id)
            .select()
            .single();
        
        if (error) throw error;
        
        console.log('âœ… Empresa atualizada:', id);
        
        res.json({ empresa: data });
        
    } catch (error) {
        console.error('âŒ Erro ao atualizar empresa:', error);
        res.status(500).json({ 
            error: 'Erro ao atualizar empresa',
            details: error.message 
        });
    }
});

// Deletar empresa
app.delete('/empresas/:id', verificarToken, async (req, res) => {
    console.log('ğŸ“¥ DELETE /empresas/:id');
    
    try {
        const { id } = req.params;
        
        // Verificar se Ã© owner
        const { data: empresa } = await supabase
            .from('empresas')
            .select('owner_id')
            .eq('id', id)
            .single();
        
        if (!empresa || empresa.owner_id !== req.userId) {
            return res.status(403).json({ error: 'Apenas o owner pode deletar' });
        }
        
        // Deletar
        const { error } = await supabase
            .from('empresas')
            .delete()
            .eq('id', id);
        
        if (error) throw error;
        
        console.log('âœ… Empresa deletada:', id);
        
        res.json({ message: 'Empresa deletada com sucesso' });
        
    } catch (error) {
        console.error('âŒ Erro ao deletar empresa:', error);
        res.status(500).json({ 
            error: 'Erro ao deletar empresa',
            details: error.message 
        });
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROTAS DE DIAGNÃ“STICOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Salvar diagnÃ³stico
app.post('/diagnosticos', verificarToken, async (req, res) => {
    console.log('ğŸ“¥ POST /diagnosticos');
    
    try {
        const { empresa_id, scores, respostas, completo } = req.body;
        
        // Inserir diagnÃ³stico
        const { data: diagnostico, error: erroDiag } = await supabase
            .from('diagnosticos')
            .insert([{
                empresa_id,
                user_id: req.userId,
                score_geral: scores?.geral || 0,
                score_tesouraria: scores?.tesouraria || 0,
                score_resultados: scores?.resultados || 0,
                score_fluxo: scores?.fluxo || 0,
                score_orcamento: scores?.orcamento || 0,
                score_investimentos: scores?.investimentos || 0,
                score_riscos: scores?.riscos || 0,
                score_indicadores: scores?.indicadores || 0,
                score_tributario: scores?.tributario || 0,
                completo: completo || false
            }])
            .select()
            .single();
        
        if (erroDiag) throw erroDiag;
        
        // Inserir respostas
        if (respostas && respostas.length > 0) {
            const respostasComDiagnostico = respostas.map(r => ({
                ...r,
                diagnostico_id: diagnostico.id
            }));
            
            const { error: erroResp } = await supabase
                .from('respostas_diagnostico')
                .insert(respostasComDiagnostico);
            
            if (erroResp) throw erroResp;
        }
        
        console.log('âœ… DiagnÃ³stico salvo:', diagnostico.id);
        
        res.status(201).json({ diagnostico });
        
    } catch (error) {
        console.error('âŒ Erro ao salvar diagnÃ³stico:', error);
        res.status(500).json({ 
            error: 'Erro ao salvar diagnÃ³stico',
            details: error.message 
        });
    }
});

// Buscar diagnÃ³sticos
app.get('/diagnosticos/:empresa_id', verificarToken, async (req, res) => {
    console.log('ğŸ“¥ GET /diagnosticos/:empresa_id');
    
    try {
        const { empresa_id } = req.params;
        
        const { data, error } = await supabase
            .from('diagnosticos')
            .select('*')
            .eq('empresa_id', empresa_id)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        console.log(`âœ… ${data.length} diagnÃ³sticos encontrados`);
        
        res.json({ diagnosticos: data });
        
    } catch (error) {
        console.error('âŒ Erro ao buscar diagnÃ³sticos:', error);
        res.status(500).json({ 
            error: 'Erro ao buscar diagnÃ³sticos',
            details: error.message 
        });
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HEALTH CHECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.get('/health', (req, res) => {
    res.json({ 
        status: 'ok', 
        message: 'Backend funcionando!',
        timestamp: new Date().toISOString()
    });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVIDOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.listen(PORT, () => {
    console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘   GESTOR FINANCEIRO 360Â° - BACKEND         â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log(`âœ… Servidor rodando na porta ${PORT}`);
    console.log(`ğŸŒ Ambiente: ${process.env.NODE_ENV || 'development'}`);
    console.log(`ğŸ“¡ CORS habilitado para: gestor360-frontend.vercel.app`);
    console.log('');
});

// Export para Vercel
module.exports = app;
